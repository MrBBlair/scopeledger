rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isOwner(uid) {
      return request.auth != null && request.auth.uid == uid;
    }

    function isAdmin() {
      return request.auth != null
        && exists(/databases/$(database)/documents/config/roles)
        && request.auth.uid in get(/databases/$(database)/documents/config/roles).data.adminUids;
    }

    function hasProjectAccess(projectId) {
      let project = get(/databases/$(database)/documents/projects/$(projectId));
      let data = project.data;
      return request.auth != null && (
        data.ownerId == request.auth.uid ||
        ('collaboratorIds' in data && request.auth.uid in data.collaboratorIds)
      );
    }

    match /config/roles {
      allow read: if request.auth != null;
      allow create: if request.auth != null && !exists(/databases/$(database)/documents/config/roles);
      allow update: if isAdmin();
    }

    match /users/{uid} {
      allow read: if isOwner(uid) || isAdmin() || request.auth != null;
      allow create: if isOwner(uid);
      allow update, delete: if isOwner(uid) || isAdmin();
    }

    match /projects/{projectId} {
      allow read: if request.auth != null && (
        resource.data.ownerId == request.auth.uid ||
        ('collaboratorIds' in resource.data && request.auth.uid in resource.data.collaboratorIds) ||
        ('pendingInvites' in resource.data && request.auth.token.email != null && request.auth.token.email in resource.data.pendingInvites)
      ) || isAdmin();
      allow create: if request.auth != null && request.resource.data.ownerId == request.auth.uid;
      allow update, delete: if hasProjectAccess(projectId) || isAdmin()
        || (request.auth != null && request.auth.token.email != null
            && 'pendingInvites' in resource.data
            && request.auth.token.email in resource.data.pendingInvites);
    }

    match /costs/{costId} {
      allow read, update, delete: if hasProjectAccess(resource.data.projectId) || isAdmin();
      allow create: if request.auth != null && hasProjectAccess(request.resource.data.projectId);
    }

    match /changeOrders/{changeOrderId} {
      allow read, update, delete: if hasProjectAccess(resource.data.projectId) || isAdmin();
      allow create: if request.auth != null && hasProjectAccess(request.resource.data.projectId);
    }

    match /forecasts/{forecastId} {
      allow read, update, delete: if hasProjectAccess(resource.data.projectId) || isAdmin();
      allow create: if request.auth != null && hasProjectAccess(request.resource.data.projectId);
    }

    match /auditLogs/{logId} {
      allow read, delete: if hasProjectAccess(resource.data.projectId) || isAdmin();
      allow create: if request.auth != null && hasProjectAccess(request.resource.data.projectId);
    }

    match /suppressedEmails/{docId} {
      allow read, write: if false;
    }
  }
}
